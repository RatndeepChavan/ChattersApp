<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pages/auth/components/OTPHandler/index.jsx - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="global.html#App">App</a></li><li><a href="Components.html">Components</a><ul class='methods'><li data-type='method'><a href="Components.html#.ArrowBackLeft">ArrowBackLeft</a></li><li data-type='method'><a href="Components.html#.FormInputField">FormInputField</a></li><li data-type='method'><a href="Components.html#.FriendRequestButton">FriendRequestButton</a></li><li data-type='method'><a href="Components.html#.LogOutButton">LogOutButton</a></li><li data-type='method'><a href="Components.html#.OTPInputField">OTPInputField</a></li><li data-type='method'><a href="Components.html#.ProfileCard">ProfileCard</a></li><li data-type='method'><a href="Components.html#.ProgressBar">ProgressBar</a></li><li data-type='method'><a href="Components.html#.Spinner">Spinner</a></li><li data-type='method'><a href="Components.html#.SubmitButton">SubmitButton</a></li><li data-type='method'><a href="Components.html#.ThemeToggler">ThemeToggler</a></li><li data-type='method'><a href="Components.html#.Timer">Timer</a></li></ul></li><li><a href="Components.Skeletons.html">Skeletons</a><ul class='methods'><li data-type='method'><a href="Components.Skeletons.html#.ProfileCardSkeleton">ProfileCardSkeleton</a></li></ul></li><li><a href="Context.html">Context</a><ul class='methods'><li data-type='method'><a href="Context.html#.SocketProvider">SocketProvider</a></li><li data-type='method'><a href="Context.html#.ThemeProvider">ThemeProvider</a></li></ul></li><li><a href="Hooks.html">Hooks</a><ul class='methods'><li data-type='method'><a href="Hooks.html#.useDebouncedQuery">useDebouncedQuery</a></li><li data-type='method'><a href="Hooks.html#.useSocketEventListener">useSocketEventListener</a></li><li data-type='method'><a href="Hooks.html#.useTheme">useTheme</a></li></ul></li><li><a href="Libs.html">Libs</a><ul class='methods'><li data-type='method'><a href="Libs.html#.refreshToken">refreshToken</a></li><li data-type='method'><a href="Libs.html#.runQueuedRequests">runQueuedRequests</a></li></ul></li><li><a href="Pages.html">Pages</a></li><li><a href="Pages.auth.html">auth</a><ul class='methods'><li data-type='method'><a href="Pages.auth.html#.Auth">Auth</a></li></ul></li><li><a href="Pages.auth.components.html">components</a><ul class='methods'><li data-type='method'><a href="Pages.auth.components.html#.LogInForm">LogInForm</a></li><li data-type='method'><a href="Pages.auth.components.html#.OTPHandler">OTPHandler</a></li><li data-type='method'><a href="Pages.auth.components.html#.SignUpForm">SignUpForm</a></li></ul></li><li><a href="Pages.chat.html">chat</a><ul class='methods'><li data-type='method'><a href="Pages.chat.html#.Chat">Chat</a></li></ul></li><li><a href="Pages.chat.components.html">components</a><ul class='methods'><li data-type='method'><a href="Pages.chat.components.html#.AddChatButton">AddChatButton</a></li><li data-type='method'><a href="Pages.chat.components.html#.ChatList">ChatList</a></li></ul></li><li><a href="Pages.chat.components.ChatContainer.html">ChatContainer</a><ul class='methods'><li data-type='method'><a href="Pages.chat.components.ChatContainer.html#.ChatContainer">ChatContainer</a></li><li data-type='method'><a href="Pages.chat.components.ChatContainer.html#.MessageForm">MessageForm</a></li></ul></li><li><a href="Pages.chat.components.NotificationDialog.html">NotificationDialog</a><ul class='methods'><li data-type='method'><a href="Pages.chat.components.NotificationDialog.html#.NotificationActions">NotificationActions</a></li><li data-type='method'><a href="Pages.chat.components.NotificationDialog.html#.NotificationButtons">NotificationButtons</a></li><li data-type='method'><a href="Pages.chat.components.NotificationDialog.html#.Notifications">Notifications</a></li></ul></li><li><a href="Pages.profile.html">profile</a><ul class='methods'><li data-type='method'><a href="Pages.profile.html#.Profile">Profile</a></li></ul></li><li><a href="Pages.profile.components.html">components</a><ul class='methods'><li data-type='method'><a href="Pages.profile.components.html#.DetailsForm">DetailsForm</a></li><li data-type='method'><a href="Pages.profile.components.html#.ProfileImage">ProfileImage</a></li><li data-type='method'><a href="Pages.profile.components.html#.ProfilePageSkeleton">ProfilePageSkeleton</a></li></ul></li><li><a href="Providers.html">Providers</a><ul class='methods'><li data-type='method'><a href="Providers.html#.CustomClientProvider">CustomClientProvider</a></li><li data-type='method'><a href="Providers.html#.CustomRouterProvider">CustomRouterProvider</a></li><li data-type='method'><a href="Providers.html#.queryClient">queryClient</a></li></ul></li><li><a href="Utils.html">Utils</a><ul class='methods'><li data-type='method'><a href="Utils.html#.handleKeyDown">handleKeyDown</a></li><li data-type='method'><a href="Utils.html#.toastNotification">toastNotification</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
    
</nav>

<div id="main">
    
    <h1 class="page-title">pages/auth/components/OTPHandler/index.jsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
	AlertDialog,
	AlertDialogCancel,
	AlertDialogContent,
	AlertDialogDescription,
	AlertDialogHeader,
	AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { useForm } from "react-hook-form";
import { Button } from "@/components/ui/button";
import { Form } from "@/components/ui/form";
import SubmitButton from "@/components/SubmitButton";
import FormInputField from "@/components/FormInputField";
import Timer from "@/components/Timer";
import { useEffect, useReducer } from "react";
import OTPInputField from "@/components/OTPInputField";
import { useMutation } from "@tanstack/react-query";
import apiClient from "@/lib/api-client";
import { useProfileStore, useUserStore } from "@/store";
import { useNavigate } from "react-router-dom";
import { GET_OTP_ROUTE, VALIDATE_OTP_ROUTE } from "@/utils/constants";
import { yupResolver } from "@hookform/resolvers/yup";
import EmailOrMobileFieldValidation from "@/validations/EmailOrMobileFieldValidation";
import { handleKeyDown } from "@/utils/helpers";

/**
 * @memberof Pages.auth.components
 *
 * @description
 * - Handles OTP-based authentication and user verification.
 * - Two step form in which user enters email or mobile to receive otp and then otp to verify it.
 * - If system already have email/mobile then jumps to otp field.
 * - To handle form events `useForm` hook from `react-hook-form` is used.
 * - Form is rendered using `shadcn Form component`,
 * - For EmailOrMobile field `Yup` validation in used and for OTP in build shadcn validation is used.
 * - `Reach Query` and `axios` is used for making &lt;b>`POST request`&lt;/b> for send otp and otp validation.
 * - For security purpose user is restricted for only one otp call in 30 seconds span.
 *
 *
 * @param {Object} props - Component properties.
 * @param {boolean} props.isOpen - Controls the open state of the dialog.
 * @param {function} props.onClose - Function to close the dialog.
 * @param {string} props.emailOrMobile - The user's email or mobile number.
 *
 * @returns {JSX.Element}  JSX element representing the SignUpForm component.
 *
 */
const OTPHandler = (props) => {
	const { isOpen, onClose, emailOrMobile } = { ...props };

	// OTP validation time in seconds
	const OTP_VALIDATION_TIME = 30; // in sec

	// Reducer Initial state
	const initialState = {
		userEmailOrMobile: emailOrMobile,
		isDisable: Boolean(emailOrMobile),
		timerKey: 0,
	};

	// Reducer function to handle the state changes for OTP handling.
	const reducer = (state, action) => {
		switch (action.type) {
			case "ENABLE_RESEND":
				return { ...state, isDisable: false };
			case "DISABLE_RESEND":
				return { ...state, isDisable: true };
			case "RESET_TIMER":
				return { ...state, timerKey: state.timerKey + 1 };
			case "SET_EMAIL_OR_MOBILE":
				return { ...state, userEmailOrMobile: action.payload };
			default:
				return state;
		}
	};

	const [state, dispatch] = useReducer(reducer, initialState);
	const { setUserInfo } = useUserStore();
	const { setProfileId } = useProfileStore();
	const navigate = useNavigate();

	// Initializing form with default values and validations
	const OTPForm = useForm({
		defaultValues: {
			emailOrMobile: emailOrMobile || "",
			otp: "",
		},

		resolver: yupResolver(EmailOrMobileFieldValidation),
	});

	// Effect to handle the OTP resend button's enable/disable state
	useEffect(() => {
		const resendTimeout = setTimeout(() => {
			dispatch({ type: "ENABLE_RESEND" });
		}, OTP_VALIDATION_TIME * 1000);

		return () => clearTimeout(resendTimeout);
	}, [state.timerKey]);

	// Request to send and validate OTP
	const sendOTPRequest = async (data) => apiClient.post(GET_OTP_ROUTE, data);
	const validateOTP = async (data) => apiClient.post(VALIDATE_OTP_ROUTE, data);

	// Mutation for sending OTP
	const { mutate: sendOTP, isPending: isSendingOTP } = useMutation({
		mutationFn: sendOTPRequest,
		onMutate: () => {
			dispatch({ type: "DISABLE_RESEND" });
		},
		onSuccess: () => {
			dispatch({ type: "RESET_TIMER" });
		},
		onError: () => {
			dispatch({ type: "ENABLE_RESEND" });
		},
	});

	// Mutation for validating OTP
	const { mutate: verifyOTP, isPending: isVerifyingOTP } = useMutation({
		mutationFn: validateOTP,
		onSuccess: (response) => {
			const userData = response.data.data;
			setUserInfo(userData);
			setProfileId(userData["_id"]);
			navigate("/chat");
		},
	});

	// Handle form submission
	const handleSubmit = (data) => {
		if (state.userEmailOrMobile) {
			verifyOTP(data);
		} else {
			dispatch({
				type: "SET_EMAIL_OR_MOBILE",
				payload: data.emailOrMobile,
			});
			sendOTP(data);
		}
	};

	return (
		&lt;AlertDialog open={isOpen} onOpenChange={onClose}>
			&lt;AlertDialogContent>
				{/* ----------------------------------------------------------
					*Alert Header
					---------------------------------------------------------- */}

				&lt;AlertDialogHeader className="flex-row justify-between items-center">
					&lt;AlertDialogTitle>
						{emailOrMobile ? "Verify Email/Mobile" : "Log in via OTP"}
					&lt;/AlertDialogTitle>
					&lt;AlertDialogCancel>X&lt;/AlertDialogCancel>
				&lt;/AlertDialogHeader>

				&lt;AlertDialogDescription className="text-destructive text-xs italic font-semibold">
					{state.userEmailOrMobile &amp;&amp; "*Only numerical input is allowed"}
				&lt;/AlertDialogDescription>
				&lt;Form {...OTPForm}>
					&lt;form
						className="w-full space-y-6"
						onSubmit={OTPForm.handleSubmit(handleSubmit)}
						onKeyDown={(event) => handleKeyDown(event, isSendingOTP || isVerifyingOTP)}
					>
						{state.userEmailOrMobile ? (
							/* ----------------------------------------------------------
								*OTP field
								---------------------------------------------------------- */

							&lt;>
								&lt;OTPInputField control={OTPForm.control} otpLength={6} />
								&lt;div className="mt-3 ext-base">
									{/* ----------------------------------------------------------
										* Timer Component
										---------------------------------------------------------- */}

									&lt;span className="text-destructive font-bold">
										{"Valid till "}
										&lt;Timer
											startTime={OTP_VALIDATION_TIME}
											key={state.timerKey}
										/>
									&lt;/span>

									{/* ----------------------------------------------------------
										* Resend Button
										---------------------------------------------------------- */}

									&lt;Button
										variant="link"
										className="text-blue-600 ps-3"
										onClick={() => {
											sendOTP({
												emailOrMobile: state.userEmailOrMobile,
												isResend: true,
											});
										}}
										disabled={state.isDisable}
									>
										Resend OTP
									&lt;/Button>
								&lt;/div>

								{/* ----------------------------------------------------------
									* Button to change email/mobile
									---------------------------------------------------------- */}

								&lt;Button
									variant="link"
									className="text-blue-600 text-italic !mt-0 ps-0"
									onClick={() => {
										dispatch({
											type: "SET_EMAIL_OR_MOBILE",
											payload: undefined,
										});
										OTPForm.reset({ otp: "", emailOrMobile: "" });
									}}
								>
									Change email or mobile number
								&lt;/Button>
							&lt;/>
						) : (
							/* ----------------------------------------------------------
								*Email Or Mobile field
								---------------------------------------------------------- */

							&lt;>
								&lt;FormInputField
									control={OTPForm.control}
									name="emailOrMobile"
									placeholder="Enter email or mobile number"
								/>
								&lt;span>Please enter your email or mobile to receive the otp&lt;/span>
							&lt;/>
						)}

						{/* ----------------------------------------------------------
							*Submit Button
							---------------------------------------------------------- */}
						&lt;SubmitButton isPending={isSendingOTP || isVerifyingOTP} />
					&lt;/form>
				&lt;/Form>
			&lt;/AlertDialogContent>
		&lt;/AlertDialog>
	);
};

export default OTPHandler;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a> on Fri Dec 27 2024 13:42:28 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
